<!DOCTYPE html>
<html>
<head>
    <title>Land Bank Parcel Selector</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* Your CSS styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
        }
        #map { 
            height: 100vh;
            width: 100vw;
        }
        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 280px;
        }
        .branch-controls {
            padding: 20px 0;
            border-top: 1px solid rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        select, button, input {
            width: 90%;
            padding: 10px;
            margin: 4px 0;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.1);
            font-size: 14px;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        button:hover {
            background: #0052a3;
        }
        h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="control-panel">
        <label for="neighborhood">Select Neighborhood:</label>
        <select id="neighborhood">
            <option value="">--Select--</option>
            <option value="Bellaire-Puritas">Bellaire-Puritas</option>
            <option value="Broadway-Slavic Village">Broadway-Slavic Village</option>
            <option value="Brooklyn Centre">Brooklyn Centre</option>
            <option value="Buckeye-Shaker Square">Buckeye-Shaker Square</option>
            <option value="Buckeye-Woodhill">Buckeye-Woodhill</option>
            <option value="Central">Central</option>
            <option value="Clark-Fulton">Clark-Fulton</option>
            <option value="Collinwood-Nottingham">Collinwood-Nottingham</option>
            <option value="Cudell">Cudell</option>
            <option value="Cuyahoga Valley">Cuyahoga Valley</option>
            <option value="Detroit Shoreway">Detroit Shoreway</option>
            <option value="Downtown">Downtown</option>
            <option value="Edgewater">Edgewater</option>
            <option value="Euclid-Green">Euclid-Green</option>
            <option value="Fairfax">Fairfax</option>
            <option value="Glenville">Glenville</option>
            <option value="Goodrich-Kirtland Pk">Goodrich-Kirtland Pk</option>
            <option value="Hopkins">Hopkins</option>
            <option value="Hough">Hough</option>
            <option value="Jefferson">Jefferson</option>
            <option value="Kamm_s">Kamm's</option>
            <option value="Kinsman">Kinsman</option>
            <option value="Lee-Harvard">Lee-Harvard</option>
            <option value="Lee-Seville">Lee-Seville</option>
            <option value="Mount Pleasant">Mount Pleasant</option>
            <option value="North Shore Collinwood">North Shore Collinwood</option>
            <option value="Ohio City">Ohio City</option>
            <option value="Old Brooklyn">Old Brooklyn</option>
            <option value="St.Clair-Superior">St.Clair-Superior</option>
            <option value="Stockyards">Stockyards</option>
            <option value="Tremont">Tremont</option>
            <option value="Union-Miles">Union-Miles</option>
            <option value="University">University</option>
            <option value="West Boulevard">West Boulevard</option>
        </select>

        <label for="devLimit">Development Limit (acres):</label>
        <input type="number" id="devLimit" value="0">

        <h2>Selected Parcels:</h2>
        <ul id="selectedParcels"></ul>

        <button id="downloadButton">Download Selected Parcels</button>
    </div>

    <script>
        // Your JavaScript code (as corrected in previous responses)
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map (centered on Cleveland for this example)
            const map = L.map('map').setView([41.49932, -81.69436], 13);

            // Add a simple base map
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 20
            }).addTo(map);

            let currentGeoJsonLayer; // To keep track of the currently loaded GeoJSON layer
            let selectedParcels = []; // Array to store selected parcel features
            let totalSelectedAcres = 0; // To track total acreage

            // Event listener for neighborhood selection
            document.getElementById('neighborhood').addEventListener('change', function() {
                const selectedNeighborhood = this.value;
                if (selectedNeighborhood) {
                    loadGeoJson(selectedNeighborhood);
                } else {
                    // Clear the map if no neighborhood is selected
                    if (currentGeoJsonLayer) {
                        map.removeLayer(currentGeoJsonLayer);
                        currentGeoJsonLayer = null;
                        selectedParcels = [];
                        totalSelectedAcres = 0;
                        updateSelectedParcelsList();
                    }
                }
            });

            // Event listener for development limit change
            document.getElementById('devLimit').addEventListener('change', function() {
                const devLimit = parseFloat(this.value);

                if (totalSelectedAcres > devLimit) {
                    alert("You have exceeded the development limit. Deselect parcels to continue.");
                    this.value = totalSelectedAcres; // Reset to the current total acreage
                }
            });

            // Function to load GeoJSON data for the selected neighborhood
            function loadGeoJson(neighborhood) {
                // Clear any existing GeoJSON layer and reset selections
                if (currentGeoJsonLayer) {
                    map.removeLayer(currentGeoJsonLayer);
                    selectedParcels = [];
                    totalSelectedAcres = 0;
                    updateSelectedParcelsList();
                }

                // Fetch and add the new GeoJSON layer
                fetch(`https://raw.githubusercontent.com/timothydehm/growthlimit/main/data/${neighborhood}.geojson`) // Update the URL structure
                    .then(response => response.json())
                    .then(data => {
                        currentGeoJsonLayer = L.geoJSON(data, {
                            onEachFeature: function (feature, layer) {
                                layer.on('click', function (e) {
                                    toggleParcelSelection(feature, layer);
                                });
                                // Optional: Add a tooltip or popup to display parcel info on hover/click
                                const parcelId = feature.properties.Parcel_ID;
                                const acres = feature.properties.Acres;
                                const todScore = feature.properties.TOD_Score;
                                layer.bindPopup(`Parcel ID: ${parcelId}<br>Acres: ${acres}<br>TOD Score: ${todScore}`);
                            }
                        }).addTo(map);
                    })
                    .catch(error => {
                        console.error('Error loading GeoJSON:', error);
                        alert('Error loading parcel data. Please make sure the neighborhood data exists.');
                    });
            }

            // Function to toggle parcel selection
            function toggleParcelSelection(feature, layer) {
                const devLimit = parseFloat(document.getElementById('devLimit').value);
                const parcelAcreage = parseFloat(feature.properties.Acres); // Assuming 'Acres' is the property name

                // Check if the parcel is already selected
                const parcelIndex = selectedParcels.findIndex(p => p.properties.Parcel_ID === feature.properties.Parcel_ID);

                if (parcelIndex > -1) {
                    // Deselect the parcel
                    selectedParcels.splice(parcelIndex, 1);
                    totalSelectedAcres -= parcelAcreage;
                    layer.setStyle({ fillColor: '#3388ff', fillOpacity: 0.5 }); // Reset to default style (or similar)
                } else {
                    // Select the parcel only if it doesn't exceed the limit
                    if (totalSelectedAcres + parcelAcreage <= devLimit) {
                        selectedParcels.push(feature);
                        totalSelectedAcres += parcelAcreage;
                        layer.setStyle({ fillColor: 'red', fillOpacity: 0.7 }); // Highlight selected parcel
                    } else {
                        alert("Adding this parcel would exceed the development limit.");
                    }
                }

                updateSelectedParcelsList();
            }

            // Function to update the list of selected parcels in the sidebar
            function updateSelectedParcelsList() {
                const list = document.getElementById('selectedParcels');
                list.innerHTML = ''; // Clear the list

                selectedParcels.forEach(parcel => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `Parcel ID: ${parcel.properties.Parcel_ID}, Acres: ${parcel.properties.Acres}, TOD Score: ${parcel.properties.TOD_Score}`; // Adjust property names as needed
                    list.appendChild(listItem);
                });
            }

            // Event listener for the download button
            document.getElementById('downloadButton').addEventListener('click', function() {
                downloadSelectedParcels();
            });

            // Function to download selected parcels as GeoJSON
            function downloadSelectedParcels() {
                if (selectedParcels.length === 0) {
                    alert('No parcels selected for download.');
                    return;
                }

                const geojson = {
                    type: "FeatureCollection",
                    features: selectedParcels
                };

                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geojson));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "selected_parcels.geojson");
                document.body.appendChild(downloadAnchorNode); // Required for Firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }
        });
    </script>
</body>
</html>
